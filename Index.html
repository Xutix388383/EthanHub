<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Blinker Tracker</title>
  <style>
    body {
      background: #111;
      color: #eee;
      font-family: 'Segoe UI', sans-serif;
      text-align: center;
      padding: 2em;
    }
    video, canvas {
      display: none;
    }
    h1 {
      color: crimson;
      font-size: 2em;
    }
    .status {
      font-size: 1.5em;
      margin-top: 1em;
    }
    .points {
      font-size: 1.2em;
      margin-top: 0.5em;
    }
  </style>
</head>
<body>
  <h1>Blinker Tracker ðŸ”¥</h1>
  <p class="status">Initializing camera...</p>
  <p class="points">Points: 0</p>
  <video id="video" autoplay></video>
  <canvas id="canvas" width="640" height="480"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const statusText = document.querySelector('.status');
    const pointsText = document.querySelector('.points');

    let tracking = false;
    let startTime = null;
    let points = 0;

    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
        statusText.textContent = "Camera ready. Waiting for LED...";
        detectLoop();
      })
      .catch(err => {
        statusText.textContent = "Camera access denied.";
        console.error(err);
      });

    function detectLoop() {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
      const brightness = getAverageBrightness(frame.data);

      const LED_THRESHOLD = 180; // tweak this based on lighting

      if (brightness > LED_THRESHOLD) {
        if (!tracking) {
          tracking = true;
          startTime = Date.now();
          statusText.textContent = "LED detected! Counting...";
        }
      } else {
        if (tracking) {
          const duration = (Date.now() - startTime) / 1000;
          tracking = false;
          handleHit(duration);
        }
      }

      requestAnimationFrame(detectLoop);
    }

    function getAverageBrightness(data) {
      let total = 0;
      for (let i = 0; i < data.length; i += 4) {
        const r = data[i], g = data[i+1], b = data[i+2];
        total += (r + g + b) / 3;
      }
      return total / (data.length / 4);
    }

    function handleHit(seconds) {
      let message = `Hit lasted ${seconds.toFixed(1)}s.`;
      if (seconds >= 20) {
        message += " ðŸš¨ Take a break and breathe!";
      } else if (seconds >= 15) {
        points += 15;
        message += " ðŸ’€ Double Rip Demon! +15 points";
      } else if (seconds >= 10) {
        points += 10;
        message += " ðŸ”¥ Blinker! +10 points";
      } else {
        message += " ðŸ˜¶ Not a blinker.";
      }
      statusText.textContent = message;
      pointsText.textContent = `Points: ${points}`;
    }
  </script>
</body>
</html>
